## JPA Lock

    Lock을 하는 이유는, 트랜잭션의 격리 수준을 선택하기 위함이다.
    격리 수준과 동시성 사이에서 저울질을 잘 해야한다.

    JPA에서 제공하는 Lock에는 2가지 종류가 있다.
    
    1. 낙관적 Lock
    2. 비관적 Lock

    [참고]
    기본적으로 Read-commited 격리수준과 Optimistic Lock 을 권장하고 (동시성)
    정보가 매우중요한 경우에만 Pessimistic Lock을 사용하자.

    알아보자.

#### 낙관적 Lock (OPTIMISTIC_LOCK)

    낙관적 락은 트랜잭션 대부분에서 충돌이 발생하지 않는다고 가정하는 Lock 방법이다.
    데이터베이스가 제공하는 Lock 기능을 사용하는 것이 아니라, JPA에서 제공하는 버전 관리 기능을 사용한다.

    즉 DB가 아닌 애플리케이션단에서 Lock을 거는 기능이다.

    트랜잭션이 커밋되기 전까지는 트랜잭션의 충돌을 알 수 없다.

#### 비관적 Lock (PESSIMISTIC_LOCK)

    비관적 락은 트랜잭션의 충돌이 발생한다고 가정하고 우선 DB에 Lock을 거는 방법이다.
    데이터베이스가 제공하는 Lock 기능을 사용한다.

    select for update (수정할거니까 건드리지마) 기능이 있다.

---

#### 두 번의 갱신 분실 문제

    A와 B가 동시에 같은 글을 수정한다.
    A가 먼저 수정해서 commit을 했는데, B가 이후에 commit을 했다.

    결과로 B가 커밋한 내용만 남고 A가 commit한 내용은 사라져버렸다.
    이를 두 번의 갱신 분실 문제라고 한다.

    이것은 데이터베이스 트랜잭션의 범위를 벗어나는 문제이다.

    이를 해결하는 방법에는 3가지 전략이 있다.

    1. 마지막 커밋만 인정
    2. 첫 커밋만 인정
    3. 충돌내용 병합

    기본적으로는 마지막 커밋이 인정된다.
    JPA에서 제공하는 버전관리를 사용하면 첫 커밋만 인정을 구현할 수 있다.